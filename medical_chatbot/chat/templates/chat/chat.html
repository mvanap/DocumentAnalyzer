{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Medical Chatbot - Chat</title>
    <link rel="stylesheet" href="{% static 'chat/chat.css' %}">
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <div class="health-icon">üè• HealthBuddy</div>

        {% if user.is_authenticated %}
        <div class="user-icon" id="userMenuBtn">
            {{ user.username|first|upper }}
        </div>
        {% endif %}
    </div>

    <!-- PROFILE MENU DROPDOWN -->
    <div class="profile-menu" id="profileMenu">
        <a href="{% url 'profile' %}">Profile Details</a>
        <a href="{% url 'settings' %}">Settings</a>
        <a href="#">Chat Theme</a>
        <a href="{% url 'logout' %}">Logout</a>
    </div>

    <!-- CHAT SECTION -->
    <div class="chat-wrapper">

        <!-- LEFT: CHAT HISTORY (hidden by default) -->
        <div class="chat-history hidden" id="chatHistory">
            <h2>Chat History</h2>
            <div class="history-list">
                <div class="history-item">Conversation 1</div>
                <div class="history-item">Conversation 2</div>
                <div class="history-item">Conversation 3</div>
            </div>
        </div>

        <!-- RIGHT: MAIN CHAT -->
        <div class="chat-main" id="chatMain">
            <h1>Medical AI Assistant</h1>

            <div id="chat" class="chat-box"></div>

            <form id="chat-form" class="chat-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Upload Button -->
                <label for="fileUpload" class="upload-btn">üìé</label>
                <input type="file" id="fileUpload" name="file" hidden>

                <input type="text" id="question" name="question" placeholder="Ask a medical question..." required autocomplete="off">
                <button type="submit">Send</button>
            </form>
        </div>

    </div>

    <script>
        /* Toggle Profile Menu */
        const userMenuBtn = document.getElementById("userMenuBtn");
        const profileMenu = document.getElementById("profileMenu");

        if (userMenuBtn) {
            userMenuBtn.addEventListener("click", () => {
                profileMenu.style.display =
                    profileMenu.style.display === "block" ? "none" : "block";
            });
        }

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".user-icon") && !e.target.closest(".profile-menu")) {
                profileMenu.style.display = "none";
            }
        });

        /* Chat Functionality */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let c of cookies) {
                    c = c.trim();
                    if (c.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(c.substring(name.length + 1));
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        const chatBox = document.getElementById('chat');

        function addMessage(sender, message) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);
            msgDiv.innerHTML = `<span>${message}</span>`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'ai', 'typing');
            typingDiv.innerHTML = `<span>...</span>`;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return typingDiv;
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const questionInput = document.getElementById('question');
            const question = questionInput.value;
            if (!question && document.getElementById("fileUpload").files.length === 0)
                return;

            // Clear input immediately
            questionInput.value = '';

            // Show the user's message in chat
            addMessage('user', question || "üìé File uploaded");

            // Show typing indicator for AI response
            const typingIndicator = showTypingIndicator();

            const formData = new FormData();
            formData.append("question", question);

            const fileInput = document.getElementById("fileUpload");
            if (fileInput.files.length > 0) {
                formData.append("file", fileInput.files[0]);
            }

            fetch('/chat/', {
                method: 'POST',
                headers: {
                    "X-CSRFToken": csrftoken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Remove the typing indicator
                typingIndicator.remove();

                // Display AI response
                addMessage('ai', data.response || data.error);

                // Clear file input
                fileInput.value = "";
            })
            .catch(err => {
                // Remove the typing indicator in case of error
                typingIndicator.remove();
                addMessage('ai', 'Something went wrong.');
            });
        });

    </script>

</body>
</html>
